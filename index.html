<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Book of Ezra</title>
    <link rel="icon" type="image/png" href="assets/images/favicon.png">

    <style>
        /* ✅ RAMI font */
        @font-face {
            font-family: 'RAMI';
            src: url('assets/fonts/RAMI.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: block;
        }

        /* ✅ GENSCO font for bottom right text */
        @font-face {
            font-family: 'GENSCO';
            src: url('assets/fonts/GENSCO.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'RAMI' !important;
            cursor: none !important;
            color: #fff;
        }

        * {
            cursor: none !important;
            font-family: 'RAMI' !important;
        }

        /* Custom rotating cursor */
        #rotating-cursor {
            position: fixed;
            width: 32px;
            height: 32px;
            background-image: url('assets/cursors/cursor.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            z-index: 10001;
            transform-origin: center center;
            animation: rotateCursor 4s linear infinite;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        #rotating-cursor.show {
            opacity: 1;
            visibility: visible;
        }

        @keyframes rotateCursor {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        #unity-container {
            position: absolute;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: black;
            z-index: 100;
        }

        #unity-canvas {
            width: 100vw;
            height: 100vh;
            display: block;
            background: #000;
            touch-action: none; /* Prevent default touch behaviors for Unity */
        }

        #fade-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            z-index: 1000;
            opacity: 1;
            transition: opacity 2s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            color: transparent;
            pointer-events: none;
        }

        #portfolio-content {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10;
            background: black url('assets/images/background.png') no-repeat center center fixed;
            background-size: cover;
        }

        #artwork-display {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        #artwork-media {
            max-width: 60vw;
            max-height: 70vh;
            object-fit: contain;
            transition: opacity 0.3s ease;
            will-change: opacity;
        }

        #artwork-media.fade-out {
            opacity: 0;
        }

        /* Unity Loading indicator - only percentage numbers */
        #unity-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: 'RAMI' !important;
            font-size: 4em;
            z-index: 200;
            opacity: 1;
            text-align: center;
        }

        /* Portfolio transition loading */
        #portfolio-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        #portfolio-loading.fade-out {
            opacity: 0;
        }

        #portfolio-loading-video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        /* Title text anchored to bottom center */
        #custom-cursor {
            position: fixed;
            bottom: 20px;
            left: 50%;
            pointer-events: none;
            z-index: 9999;
            font-family: 'RAMI' !important;
            font-size: 16px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.5s ease;
            animation: breathe 2s ease-in-out infinite;
            will-change: transform, opacity, color;
            transform: translateX(-50%);
        }

        @keyframes breathe {
            0%, 100% {
                opacity: 0.44;
                transform: translateX(-50%) scale(0.44);
                color: #ffff00;
            }
            16.66% {
                color: #ccff00;
            }
            33.33% {
                opacity: 1;
                transform: translateX(-50%) scale(1.13);
                color: #99ff00;
            }
            50% {
                color: #66ff33;
            }
            66.66% {
                color: #33ff99;
            }
            83.33% {
                color: #00ccff;
            }
        }

        #custom-cursor.show {
            opacity: 1;
        }

        /* ✅ NEW: Bottom right GENSCO text */
        #bottom-right-text {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-family: 'GENSCO' !important;
            font-size: 14px;
            color: #ffffff;
            opacity: 0.7;
            pointer-events: none;
            z-index: 9998;
            text-align: right;
            line-height: 1.2;
        }

        /* ✅ NEW: Mobile touch area (invisible overlay for touch events) */
        #mobile-touch-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 25;
            background: transparent;
            display: none;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Show mobile touch area only when portfolio is active */
        #portfolio-content.active #mobile-touch-area {
            display: block;
        }

        /* ✅ ENHANCED Mobile-specific scaling and full-screen display */
        @media (max-width: 768px) {
            #artwork-display {
                padding: 0;
                margin: 0;
            }
            
            #artwork-media {
                max-width: 100vw !important;
                max-height: 100vh !important;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                object-position: center;
                position: absolute;
                top: 0;
                left: 0;
            }
            
            #custom-cursor {
                font-size: 14px;
                bottom: 30px;
                z-index: 9999;
            }
            
            #bottom-right-text {
                font-size: 12px;
                bottom: 15px;
                right: 15px;
                z-index: 9999;
            }
        }

        /* ✅ ENHANCED Mobile scaling for smaller screens */
        @media (max-width: 480px) {
            #artwork-media {
                max-width: 100vw !important;
                max-height: 100vh !important;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                object-position: center;
            }
            
            #custom-cursor {
                font-size: 12px;
                bottom: 25px;
            }
            
            #bottom-right-text {
                font-size: 10px;
                bottom: 10px;
                right: 10px;
            }
        }

        /* ✅ ENHANCED Mobile landscape orientation optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            #artwork-media {
                max-width: 100vw !important;
                max-height: 100vh !important;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                object-position: center;
            }
            
            #custom-cursor {
                bottom: 15px;
                font-size: 13px;
            }
        }

        /* ✅ ENHANCED Mobile portrait orientation optimization */
        @media (max-width: 768px) and (orientation: portrait) {
            #artwork-media {
                max-width: 100vw !important;
                max-height: 100vh !important;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                object-position: center;
            }
            
            #custom-cursor {
                bottom: 40px;
                font-size: 14px;
            }
        }

        /* ✅ NEW: Enhanced Mobile scaling for transition video */
        @media (max-width: 768px) {
            #portfolio-loading-video {
                width: 100vw !important;
                height: 100vh !important;
                object-fit: cover;
                object-position: center;
                position: absolute;
                top: 0;
                left: 0;
            }
        }

        /* ✅ NEW: Mobile landscape transition video optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            #portfolio-loading-video {
                width: 100vw !important;
                height: 100vh !important;
                object-fit: cover;
                object-position: center;
            }
        }

        /* ✅ NEW: Mobile portrait transition video optimization */
        @media (max-width: 768px) and (orientation: portrait) {
            #portfolio-loading-video {
                width: 100vw !important;
                height: 100vh !important;
                object-fit: cover;
                object-position: center;
            }
        }
    </style>
</head>
<body>

    <!-- Custom rotating cursor -->
    <div id="rotating-cursor"></div>

    <!-- Unity loading indicator -->
    <div id="unity-loading">0%</div>

    <!-- Portfolio transition loading -->
    <div id="portfolio-loading">
        <video id="portfolio-loading-video" muted autoplay loop playsinline playbackRate="0.66">
            <source src="assets/videos/transition.mp4" type="video/mp4">
            <source src="assets/videos/transition.webm" type="video/webm">
        </video>
    </div>

    <!-- Unity WebGL containers -->
    <div id="fade-overlay"></div>
    <div id="unity-container">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
    </div>

    <!-- Portfolio content -->
    <div id="portfolio-content">
        <!-- ✅ NEW: Mobile touch area -->
        <div id="mobile-touch-area"></div>
        
        <div id="artwork-display">
            <img id="artwork-media" src="" alt="Artwork" style="opacity: 0;">
        </div>
        <div id="custom-cursor"></div>
        
        <!-- ✅ NEW: Bottom right GENSCO text -->
        <div id="bottom-right-text" style="display: none;">
            ezrasilva@proton.me
        </div>
    </div>

    <!-- Unity loader -->
    <script src="Build/Table.loader.js"></script>

    <script>
        let unityInstance = null;
        let currentArtworkName = '';

        // ✅ NEW: Unity-Website Touch Coordination
        window.unityTouchActive = false;
        window.SetUnityTouchMode = function(active) {
            window.unityTouchActive = active;
            console.log("Unity touch mode:", active ? "ACTIVE" : "INACTIVE");
            
            // Disable/enable website touch accordingly
            if (active) {
                // Unity is handling touches - disable website touch
                const mobileArea = document.getElementById('mobile-touch-area');
                if (mobileArea) {
                    mobileArea.style.pointerEvents = 'none';
                }
            } else {
                // Unity finished - enable website touch
                const mobileArea = document.getElementById('mobile-touch-area');
                if (mobileArea) {
                    mobileArea.style.pointerEvents = 'auto';
                }
            }
        };

        // ✅ NEW: Mobile detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.maxTouchPoints && navigator.maxTouchPoints > 2) ||
                         window.innerWidth <= 768;

        console.log("Device detected:", isMobile ? "Mobile" : "Desktop");

        // Rotating cursor system
        const rotatingCursor = {
            element: null,
            
            init() {
                this.element = document.getElementById('rotating-cursor');
                
                // Track mouse movement (desktop only)
                if (!isMobile) {
                    document.addEventListener('mousemove', (e) => {
                        if (this.element) {
                            this.element.style.left = (e.clientX - 16) + 'px'; // Center cursor (16px offset for 32px cursor)
                            this.element.style.top = (e.clientY - 16) + 'px';
                        }
                    });
                }
                
                console.log("Rotating cursor initialized (hidden)");
            },
            
            show() {
                if (this.element && !isMobile) { // Only show on desktop
                    this.element.classList.add('show');
                    console.log("Rotating cursor shown");
                }
            },
            
            hide() {
                if (this.element) {
                    this.element.classList.remove('show');
                    console.log("Rotating cursor hidden");
                }
            }
        };

        // Initialize rotating cursor immediately
        document.addEventListener('DOMContentLoaded', () => {
            rotatingCursor.init();
        });

        // Also initialize on window load as backup
        window.addEventListener('load', () => {
            rotatingCursor.init();
        });

        // Audio System for Portfolio
        const audioSystem = {
            backgroundAudio: null,
            clickAudio: null,
            audioInitialized: false,
            
            async init() {
                try {
                    // Initialize background audio
                    this.backgroundAudio = new Audio('assets/audio/background.mp3');
                    this.backgroundAudio.loop = true;
                    this.backgroundAudio.volume = 0.3; // 30% volume
                    
                    // Initialize click sound
                    this.clickAudio = new Audio('assets/audio/click.mp3');
                    this.clickAudio.volume = 0.5; // 50% volume
                    
                    console.log("Audio system initialized");
                    this.audioInitialized = true;
                } catch (error) {
                    console.warn("Audio initialization failed:", error);
                }
            },
            
            async startBackgroundMusic() {
                if (this.backgroundAudio && this.audioInitialized) {
                    try {
                        await this.backgroundAudio.play();
                        console.log("Background music started");
                    } catch (error) {
                        console.warn("Background music failed to start:", error);
                    }
                }
            },
            
            playClickSound() {
                if (this.clickAudio && this.audioInitialized) {
                    try {
                        this.clickAudio.currentTime = 0; // Reset to start
                        const playPromise = this.clickAudio.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(e => console.warn("Click sound failed:", e));
                        }
                        console.log("Click sound played");
                    } catch (error) {
                        console.warn("Click sound error:", error);
                    }
                }
            },
            
            stopBackgroundMusic() {
                if (this.backgroundAudio) {
                    this.backgroundAudio.pause();
                    this.backgroundAudio.currentTime = 0;
                }
            }
        };

        // Portfolio Loading System
        const portfolioLoader = {
            isLoading: false,
            startTime: null,
            duration: 8000, // 8 seconds loading
            
            show() {
                const loadingElement = document.getElementById('portfolio-loading');
                const videoElement = document.getElementById('portfolio-loading-video');
                
                loadingElement.style.display = 'flex';
                loadingElement.classList.remove('fade-out');
                
                // ✅ FIX: Ensure video plays on mobile
                if (videoElement) {
                    videoElement.playbackRate = 0.66;
                    // Force play for mobile
                    const playPromise = videoElement.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(() => {
                            console.warn("Video autoplay failed, continuing with timer");
                        });
                    }
                }
                
                this.isLoading = true;
                this.startTime = Date.now();
                this.updateProgress();
                
                console.log("Portfolio loading started");
            },
            
            updateProgress() {
                if (!this.isLoading) return;
                
                const elapsed = Date.now() - this.startTime;
                const progress = Math.min(elapsed / this.duration, 1);
                
                if (progress < 1) {
                    requestAnimationFrame(() => this.updateProgress());
                } else {
                    this.fadeOutAndComplete();
                }
            },
            
            fadeOutAndComplete() {
                const loadingElement = document.getElementById('portfolio-loading');
                
                // Start fade out
                loadingElement.classList.add('fade-out');
                
                // Complete after fade out finishes
                setTimeout(() => {
                    this.complete();
                }, 1000); // Wait for 1s fade out transition
            },
            
            complete() {
                this.isLoading = false;
                document.getElementById('portfolio-loading').style.display = 'none';
                const portfolioContent = document.getElementById('portfolio-content');
                portfolioContent.style.display = 'block';
                portfolioContent.classList.add('active');
                
                // Initialize portfolio systems
                customCursor.init();
                titleManager.init();
                
                // ✅ FIX: Ensure audio starts on mobile after user interaction
                setTimeout(() => {
                    audioSystem.startBackgroundMusic();
                }, 100);
                
                artworkManager.loadMediaFiles();
                
                console.log("Portfolio loading complete - portfolio active");
            }
        };

        // Proper Unity Audio Initialization
        const unityAudioSystem = {
            context: null,
            initialized: false,
            
            async initialize() {
                if (this.initialized) return;
                
                try {
                    // Create Web Audio context for Unity
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Resume context if suspended (required by browsers)
                    if (this.context.state === 'suspended') {
                        await this.context.resume();
                    }
                    
                    // ✅ CRITICAL: Unity looks for Module.audioContext, not window.unityAudioContext
                    window.Module = window.Module || {};
                    window.Module.audioContext = this.context;
                    
                    this.initialized = true;
                    console.log("Unity audio context initialized and assigned to Module.audioContext");
                } catch (error) {
                    console.error("Unity audio initialization failed:", error);
                }
            },
            
            // Ensure audio context is active for Unity
            ensureActive() {
                if (this.context && this.context.state === 'suspended') {
                    this.context.resume();
                }
            }
        };

        // Initialize audio on first user interaction
        function initializeAllAudio() {
            unityAudioSystem.initialize();
            audioSystem.init();
        }

        // Add event listeners for audio initialization
        document.addEventListener('click', initializeAllAudio, { once: true });
        document.addEventListener('keydown', initializeAllAudio, { once: true });
        document.addEventListener('touchstart', initializeAllAudio, { once: true });

        // Title Management System - Direct correspondence to artwork
        const titleManager = {
            artworkTitles: [
                "FIGURE PATERNELLE",           // artwork01
                "AP",          // artwork02
                "PINA",           // artwork03
                "MAUVAISES HABITUDES II",          // artwork04
                "DISCIPLINE",           // artwork05
                "MAUVAISES HABITUDES I",           // artwork06
                "BOY",         // artwork07
                "HAPPY ENDING",          // artwork08
                "ON MONDAYS",           // artwork09
                "A GATHERING",           // artwork10
                "AUGUST",        // artwork11
                "LOU II",         // artwork12
                "SPOON",      // artwork13
                "FLEUVE",      // artwork14
                "ARC EN CIEL",       // artwork15
                "PRAYER BEADS",       // artwork16
                "CLOUDS",     // artwork17
                "LOU I",      // artwork18
                "MAREE",      // artwork19
                "FLAMMES",       // artwork20
                "SOIREE",    // artwork21
                "PLANET FILTH",   // artwork22
                "BUDAPEST PAGE",    // artwork23
                "FLOWER STUDIES",   // artwork24
                "VAGUE",    // artwork25
                "ENFANCE",    // artwork26
                "LOU III",  // artwork27
                "ABLATION",   // artwork28
                "ANYTHING",    // artwork29
                "BURIAL OF ACHILLES",       // artwork30
                "RINGER",    // artwork31
                "LECTEUR",   // artwork32
                "GESHA",    // artwork33
                "SEED",   // artwork34
                "FAIRY",    // artwork35
                "LUMIERE ABOMINABLE",    // artwork36
                "WEIGHTS",  // artwork37
                "DIFFFRACTION",   // artwork38
                "HAPPY THOUGHTS",    // artwork39
                "ARBRE",        // artwork40
                "ANGEL",     // artwork41
                "COMPA",    // artwork42
                "RAT",     // artwork43
                "MACBETH",    // artwork44
                "OMELETTE",     // artwork45
                "SPOTLIGHT",     // artwork46
                "LABYRYNTH",   // artwork47
                "MAUVAISES HABITUDES IV",    // artwork48
                "AFFICHE",     // artwork49
                "APPENDIX",        // artwork50
                "HEAD",     // artwork51
                "DEEP OCEAN VAST SEA",     // artwork52
                "CASCADE",     // artwork53
                "DRAG",     // artwork54
                "AS ANY OTHER DOOR",     // artwork55
                "TOURNESOL",     // artwork56
                "JANE",     // artwork57
                "PICNIC",     // artwork58
                "INTRODUCTION",     // artwork59
                "VER",     // artwork60
                "ARCHIPELAGO",     // artwork61
                "4 AM",     // artwork62
                "FUMEE",     // artwork63
                "MONOLOGUE",     // artwork64
                "MAUVAISES HABITUDES V",     // artwork65
                "COMA WITH HIS THOUGHTS",     // artwork66
                "ESCARGOT",     // artwork67
                "ROPE",     // artwork68
                "NIGHT OF THE HUNTER",     // artwork69
                "TRIPTYCH I",     // artwork70
                "TRIPTYCH II",     // artwork71
                "VOYEUR",     // artwork72
                "VAMPYR",     // artwork73
                "MECHE",     // artwork74
                "THE SUN THROUGH THE BLINDS",     // artwork75
                "EARRING",     // artwork76
                "SANSTITRE",     // artwork77
                "WALTZ",     // artwork78
                "5/4",     // artwork79
                
            ],
            
            init() {
                console.log(`Title system initialized with ${this.artworkTitles.length} titles`);
            },
            
            getTitleForArtwork(artworkIndex) {
                const titleIndex = artworkIndex - 1;
                
                if (titleIndex >= 0 && titleIndex < this.artworkTitles.length) {
                    return this.artworkTitles[titleIndex];
                } else {
                    return `ARTWORK ${artworkIndex}`;
                }
            }
        };

        // Title management - Bottom center positioning
        const customCursor = {
            element: null,
            
            init() {
                this.element = document.getElementById('custom-cursor');
            },
            
            show(text) {
                if (this.element) {
                    this.element.textContent = text;
                    this.element.classList.add('show');
                }
            },
            
            hide() {
                if (this.element) {
                    this.element.classList.remove('show');
                }
            },
            
            update(title) {
                this.show(title);
            }
        };

        // ✅ NEW: Mobile Touch System
        const mobileTouch = {
            touchArea: null,
            
            init() {
                this.touchArea = document.getElementById('mobile-touch-area');
                if (this.touchArea && isMobile) {
                    this.setupTouchEvents();
                    console.log("Mobile touch system initialized");
                }
            },
            
            setupTouchEvents() {
                let touchStartTime = 0;
                let touchStartPos = { x: 0, y: 0 };
                
                this.touchArea.addEventListener('touchstart', (e) => {
                    // Check if Unity is handling touches
                    if (window.unityTouchActive) {
                        console.log("Touch ignored - Unity is active");
                        return;
                    }
                    
                    e.preventDefault();
                    touchStartTime = Date.now();
                    
                    // Record touch start position
                    if (e.touches.length > 0) {
                        touchStartPos.x = e.touches[0].clientX;
                        touchStartPos.y = e.touches[0].clientY;
                    }
                    
                    console.log("Touch started");
                }, { passive: false });
                
                this.touchArea.addEventListener('touchend', (e) => {
                    // Check if Unity is handling touches
                    if (window.unityTouchActive) {
                        console.log("Touch end ignored - Unity is active");
                        return;
                    }
                    
                    e.preventDefault();
                    const touchDuration = Date.now() - touchStartTime;
                    
                    // Calculate movement distance if touch end position is available
                    let moveDistance = 0;
                    if (e.changedTouches.length > 0) {
                        const endX = e.changedTouches[0].clientX;
                        const endY = e.changedTouches[0].clientY;
                        moveDistance = Math.sqrt(
                            Math.pow(endX - touchStartPos.x, 2) + 
                            Math.pow(endY - touchStartPos.y, 2)
                        );
                    }
                    
                    // ✅ ENHANCED: Both tap and swipe gestures trigger artwork change (under 1000ms)
                    if (touchDuration < 1000) {
                        console.log("Touch gesture detected (tap or swipe) - triggering artwork change");
                        
                        // ✅ IMPROVED: Play click sound immediately for better responsiveness
                        audioSystem.playClickSound();
                        
                        // Trigger artwork change with minimal delay
                        setTimeout(() => {
                            artworkManager.showNextArtwork();
                        }, 20);
                    }
                }, { passive: false });
                
                // Prevent context menu and other touch behaviors
                this.touchArea.addEventListener('contextmenu', (e) => {
                    if (window.unityTouchActive) return;
                    e.preventDefault();
                });
                
                this.touchArea.addEventListener('touchmove', (e) => {
                    if (window.unityTouchActive) return;
                    e.preventDefault();
                }, { passive: false });
            }
        };

        // Chronological Display System
        const artworkManager = {
            mediaFiles: [],
            currentIndex: 0,
            isLoading: false,
            viewedArtworks: new Set(), // Track viewed artworks
            
            async loadMediaFiles() {
                console.log("Loading artwork files...");
                
                const extensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'mp4', 'webm', 'mov'];
                
                for (let i = 1; i <= 100; i++) {
                    for (let ext of extensions) {
                        try {
                            const paddedNumber = i.toString().padStart(2, '0');
                            const urlWithZero = `assets/artwork/artwork${paddedNumber}.${ext}`;
                            const existsWithZero = await this.checkFileExists(urlWithZero);
                            
                            if (existsWithZero) {
                                this.mediaFiles.push({
                                    url: urlWithZero,
                                    type: ['mp4', 'webm', 'mov'].includes(ext) ? 'video' : 'image',
                                    name: `artwork${paddedNumber}.${ext}`,
                                    index: i,
                                    id: this.mediaFiles.length
                                });
                                console.log(`Found: ${urlWithZero}`);
                                continue;
                            }
                            
                            const urlWithoutZero = `assets/artwork/artwork${i}.${ext}`;
                            const existsWithoutZero = await this.checkFileExists(urlWithoutZero);
                            
                            if (existsWithoutZero) {
                                this.mediaFiles.push({
                                    url: urlWithoutZero,
                                    type: ['mp4', 'webm', 'mov'].includes(ext) ? 'video' : 'image',
                                    name: `artwork${i}.${ext}`,
                                    index: i,
                                    id: this.mediaFiles.length
                                });
                                console.log(`Found: ${urlWithoutZero}`);
                            }
                        } catch (error) {
                            // File doesn't exist, continue
                        }
                    }
                }
                
                console.log(`✅ TOTAL LOADED: ${this.mediaFiles.length} artwork files`);
                
                if (this.mediaFiles.length > 0) {
                    this.showNextArtwork();
                } else {
                    console.warn("❌ No artwork files found. Make sure files are in assets/artwork/ folder");
                }
            },
            
            async checkFileExists(url) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    return response.ok;
                } catch {
                    return false;
                }
            },
            
            showNextArtwork() {
                if (this.isLoading || this.mediaFiles.length === 0) return;
                
                this.isLoading = true;
                const artworkMedia = document.getElementById('artwork-media');
                
                if (artworkMedia) {
                    artworkMedia.classList.add('fade-out');
                }
                
                setTimeout(() => {
                    const mediaFile = this.mediaFiles[this.currentIndex];
                    this.currentIndex = (this.currentIndex + 1) % this.mediaFiles.length;
                    
                    currentArtworkName = mediaFile.name;
                    
                    const artworkDisplay = document.getElementById('artwork-display');
                    
                    const existingMedia = document.getElementById('artwork-media');
                    if (existingMedia && existingMedia.parentNode) {
                        existingMedia.parentNode.removeChild(existingMedia);
                    }
                    
                    const newMedia = mediaFile.type === 'video' 
                        ? document.createElement('video')
                        : document.createElement('img');
                    
                    newMedia.id = 'artwork-media';
                    newMedia.style.maxWidth = '60vw';
                    newMedia.style.maxHeight = '70vh';
                    newMedia.style.objectFit = 'contain';
                    newMedia.style.transition = 'opacity 0.3s ease';
                    newMedia.style.opacity = '0';
                    
                    if (mediaFile.type === 'video') {
                        newMedia.autoplay = true;
                        newMedia.loop = true;
                        newMedia.muted = true;
                        newMedia.controls = false;
                    }
                    
                    newMedia.onload = newMedia.onloadeddata = () => {
                        newMedia.style.opacity = '1';
                        this.isLoading = false;
                        
                        // Track viewed artwork
                        this.viewedArtworks.add(mediaFile.index);
                        
                        // Show contact info if all artworks viewed
                        if (this.viewedArtworks.size === this.mediaFiles.length) {
                            document.getElementById('bottom-right-text').style.display = 'block';
                        }
                        
                        const artworkNumber = mediaFile.index;
                        const properTitle = titleManager.getTitleForArtwork(artworkNumber);
                        customCursor.update(properTitle);
                        
                        // ✅ REMOVED: Click sound now plays immediately on touch for better mobile responsiveness
                        
                        console.log(`✅ Showing: ${mediaFile.name} | Title: "${properTitle}"`);
                    };
                    
                    newMedia.onerror = () => {
                        console.error(`❌ Failed to load: ${mediaFile.name}`);
                        this.isLoading = false;
                        setTimeout(() => this.showNextArtwork(), 500);
                    };
                    
                    newMedia.src = mediaFile.url;
                    newMedia.alt = mediaFile.name;
                    
                    artworkDisplay.appendChild(newMedia);
                    
                }, 300);
            },
            
            showRandomArtwork() {
                this.showNextArtwork();
            }
        };

        function UnlockWebsitePortfolio() {
            // ✅ NEW: Disable Unity touch mode
            window.SetUnityTouchMode(false);
            
            // ✅ FIX: Initialize audio for mobile (user gesture already occurred in Unity)
            if (!audioSystem.audioInitialized) {
                audioSystem.init();
            }
            
            // Hide Unity elements
            document.getElementById('unity-loading').style.display = 'none';
            document.getElementById('fade-overlay').style.display = 'none';
            document.getElementById('unity-container').style.display = 'none';
            
            // Keep cursor hidden during transition
            rotatingCursor.hide();
            
            // Start portfolio loading transition
            portfolioLoader.show();
            
            console.log("Unity game completed - starting portfolio transition");
        }

        /*
        ✅ UNITY INTEGRATION INSTRUCTIONS:
        
        In your Unity SimpleTouchController script, add these calls:
        
        1. When Unity game starts handling input:
           Application.ExternalEval("window.SetUnityTouchMode(true);");
        
        2. When Unity finishes (before calling UnlockWebsitePortfolio):
           Application.ExternalEval("window.SetUnityTouchMode(false);");
        
        3. When transitioning to portfolio:
           Application.ExternalEval("window.UnlockWebsitePortfolio();");
        
        This ensures proper touch coordination between Unity and the website.
        */

        window.UnlockWebsitePortfolio = UnlockWebsitePortfolio;

        window.addEventListener('load', () => {
            const canvas = document.querySelector("#unity-canvas");
            if (typeof createUnityInstance === 'function') {
                createUnityInstance(canvas, {
                    dataUrl: "Build/Table.data",
                    frameworkUrl: "Build/Table.framework.js",
                    codeUrl: "Build/Table.wasm",
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "DefaultCompany",
                    productName: "Table",
                    productVersion: "0.1.0",
                    matchWebGLToCanvasSize: false,
                    devicePixelRatio: window.devicePixelRatio || 1
                }, (progress) => {
                    const loadingElement = document.getElementById('unity-loading');
                    const percentage = Math.round(progress * 100);
                    loadingElement.textContent = `${percentage}%`;
                    console.log(`Unity Loading: ${percentage}%`);
                }).then((instance) => {
                    unityInstance = instance;
                    
                    // ✅ NEW: Enable Unity touch mode when game is ready
                    window.SetUnityTouchMode(true);
                    
                    // Ensure Unity audio is properly initialized
                    unityAudioSystem.ensureActive();
                    
                    // Hide loading when Unity is ready
                    document.getElementById('unity-loading').style.display = 'none';
                    
                    function resizeUnityCanvas() {
                        const rect = canvas.getBoundingClientRect();
                        canvas.width = rect.width * (window.devicePixelRatio || 1);
                        canvas.height = rect.height * (window.devicePixelRatio || 1);
                    }
                    resizeUnityCanvas();
                    window.addEventListener('resize', resizeUnityCanvas);
                }).catch((message) => {
                    console.error("Unity Error:", message);
                    // ✅ NEW: Ensure Unity touch mode is disabled on error
                    window.SetUnityTouchMode(false);
                    UnlockWebsitePortfolio();
                });
            } else {
                console.error("Unity loader not found.");
                // ✅ NEW: Ensure Unity touch mode is disabled if loader missing
                window.SetUnityTouchMode(false);
                UnlockWebsitePortfolio();
            }
        });

        // Setup portfolio event listeners after loading completes
        function setupPortfolioEvents() {
            // Desktop click events (only if not mobile)
            if (!isMobile) {
                document.getElementById('portfolio-content').addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log("Desktop click detected - flipping to next artwork");
                    
                    // ✅ ADDED: Play click sound for desktop clicks
                    audioSystem.playClickSound();
                    
                    artworkManager.showNextArtwork();
                });
                
                document.getElementById('portfolio-content').addEventListener('mouseenter', () => {
                    if (currentArtworkName) {
                        const match = currentArtworkName.match(/artwork(\d+)/);
                        if (match) {
                            const artworkNumber = parseInt(match[1]);
                            const properTitle = titleManager.getTitleForArtwork(artworkNumber);
                            customCursor.show(properTitle);
                        }
                    }
                });
                
                document.getElementById('portfolio-content').addEventListener('mouseleave', () => {
                    customCursor.hide();
                });
            }
            
            // ✅ NEW: Initialize mobile touch events
            mobileTouch.init();
        }

        // Call setup when portfolio loading completes
        portfolioLoader.complete = function() {
            this.isLoading = false;
            document.getElementById('portfolio-loading').style.display = 'none';
            const portfolioContent = document.getElementById('portfolio-content');
            portfolioContent.style.display = 'block';
            portfolioContent.classList.add('active'); // ✅ NEW: Add active class
            
            // Initialize portfolio systems
            customCursor.init();
            titleManager.init();
            audioSystem.startBackgroundMusic();
            artworkManager.loadMediaFiles();
            
            // Show rotating cursor when portfolio is active (desktop only)
            if (!isMobile) {
                rotatingCursor.show();
            }
            
            // Setup event listeners
            setupPortfolioEvents();
            
            console.log("Portfolio loading complete - portfolio active");
        };

        let cursorTimeout;
        const hideDelay = 3000;

        function resetCursorTimer() {
            if (document.getElementById('portfolio-content').style.display === 'block') {
                clearTimeout(cursorTimeout);
                cursorTimeout = setTimeout(() => {
                    customCursor.hide();
                }, hideDelay);
            }
        }

        // ✅ Modified: Only add mouse events for desktop
        if (!isMobile) {
            ['mousemove', 'mousedown', 'keydown'].forEach(evt =>
                document.addEventListener(evt, resetCursorTimer)
            );
        }

        // Touch events for mobile cursor timer
        if (isMobile) {
            ['touchstart', 'touchmove'].forEach(evt =>
                document.addEventListener(evt, resetCursorTimer)
            );
        }
    </script>
</body>
</html>