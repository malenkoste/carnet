<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Livre d'Ezra</title>
    <link rel="icon" type="image/png" href="assets/images/favicon.png">

    <style>
        @font-face {
            font-family: 'RAMI';
            src: url('assets/fonts/RAMI.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: block;
        }

        @font-face {
            font-family: 'GENSCO';
            src: url('assets/fonts/GENSCO.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'RAMI' !important;
            cursor: none !important;
            color: #fff;
        }

        * {
            cursor: none !important;
            font-family: 'RAMI' !important;
        }

        #rotating-cursor {
            position: fixed;
            width: 32px;
            height: 32px;
            background-image: url('assets/cursors/cursor.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            z-index: 10001;
            transform-origin: center center;
            animation: rotateCursor 4s linear infinite;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        #rotating-cursor.show {
            opacity: 1;
            visibility: visible;
        }

        @keyframes rotateCursor {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        #unity-container {
            position: absolute;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: black;
            z-index: 100;
        }

        #unity-canvas {
            width: 100vw;
            height: 100vh;
            display: block;
            background: #000;
            touch-action: none;
        }

        #fade-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            z-index: 1000;
            opacity: 1;
            transition: opacity 2s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            color: transparent;
            pointer-events: none;
        }

        #portfolio-content {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10;
            background: black url('assets/images/background.png') no-repeat center center fixed;
            background-size: cover;
        }

        #artwork-display {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        #artwork-media {
            max-width: 60vw;
            max-height: 70vh;
            object-fit: contain;
            transition: opacity 0.3s ease; /* Keep initial fade-out */
            will-change: opacity, transform, clip-path;
        }

        /* Wavy transition animations */
        @keyframes wavy-out {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
                clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
            }
            25% {
                transform: translateY(-10%) scale(1.05);
                clip-path: polygon(0% 0%, 100% 0%, 100% 70%, 0% 80%);
            }
            50% {
                opacity: 0.5;
                transform: translateY(10%) scale(0.95);
                clip-path: polygon(0% 0%, 100% 0%, 100% 30%, 0% 20%);
            }
            75% {
                transform: translateY(-5%) scale(1.02);
                clip-path: polygon(0% 0%, 100% 0%, 100% 10%, 0% 0%);
            }
            100% {
                opacity: 0;
                transform: translateY(0) scale(0.8);
                clip-path: polygon(0% 0%, 100% 0%, 100% 0%, 0% 0%);
            }
        }

        @keyframes wavy-in {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0.8);
                clip-path: polygon(0% 0%, 100% 0%, 100% 0%, 0% 0%);
            }
            25% {
                transform: translateY(5%) scale(1.02);
                clip-path: polygon(0% 0%, 100% 0%, 100% 10%, 0% 20%);
            }
            50% {
                opacity: 0.5;
                transform: translateY(-10%) scale(0.95);
                clip-path: polygon(0% 0%, 100% 0%, 100% 70%, 0% 80%);
            }
            75% {
                transform: translateY(10%) scale(1.05);
                clip-path: polygon(0% 0%, 100% 0%, 100% 90%, 0% 100%);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
            }
        }

        #artwork-media.wavy-out {
            animation: wavy-out 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* Groovy ease-out */
        }

        #artwork-media.wavy-in {
            animation: wavy-in 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* Groovy ease-in */
        }

        #unity-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: 'RAMI' !important;
            font-size: 4em;
            z-index: 200;
            opacity: 1;
            text-align: center;
        }

        #portfolio-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        #portfolio-loading.fade-out {
            opacity: 0;
        }

        #portfolio-loading-video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        #custom-cursor {
            position: fixed;
            bottom: 20px;
            left: 50%;
            pointer-events: none;
            z-index: 9999;
            font-family: 'RAMI' !important;
            font-size: 16px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.5s ease;
            animation: breathe 2s ease-in-out infinite;
            will-change: transform, opacity, color;
            transform: translateX(-50%);
        }

        @keyframes breathe {
            0%, 100% {
                opacity: 0.44;
                transform: translateX(-50%) scale(0.44);
                color: #ffff00;
            }
            14.28% {
                color: #ccff00; /* Original color */
            }
            28.56% {
                color: #99ff00; /* Original color */
            }
            42.84% {
                opacity: 1;
                transform: translateX(-50%) scale(1.13);
                color: #66ff33; /* Original color */
            }
            57.12% {
                color: #33ff99; /* Original color */
            }
            71.4% {
                color: #00ccff; /* Original color */
            }
            85.68% {
                color: #FF0000; /* Red hue */
            }
            92.84% {
                color: #000000; /* Black hue */
            }
        }

        #custom-cursor.show {
            opacity: 1;
        }

        #bottom-right-text {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-family: 'GENSCO' !important;
            font-size: 14px;
            color: #ffffff;
            opacity: 0.7;
            pointer-events: none;
            z-index: 9998;
            text-align: right;
            line-height: 1.2;
        }

        #mobile-touch-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 25;
            background: transparent;
            display: none;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #portfolio-content.active #mobile-touch-area {
            display: block;
        }

        #tap-click-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10002;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
            color: white;
        }

        #tap-click-container.show {
            opacity: 1;
        }

        #tap-click-main-text {
            font-family: 'RAMI' !important;
            font-size: 2em;
            white-space: nowrap;
            display: block;
        }

        #tap-click-mobile-text {
            font-family: 'GENSCO' !important;
            font-size: 1em; /* Adjust size relative to main text */
            margin-top: 5px; /* Spacing between the two lines */
            display: block;
        }

        @media (max-width: 768px) {
            #artwork-display {
                padding: 0;
                margin: 0;
            }
            
            #artwork-media {
                max-width: 100vw !important;
                max-height: 100vh !important;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                object-position: center;
                position: absolute;
                top: 0;
                left: 0;
            }
            
            #custom-cursor {
                font-size: 14px;
                bottom: 30px;
                z-index: 9999;
            }
            
            #bottom-right-text {
                font-size: 12px;
                bottom: 15px;
                right: 15px;
                z-index: 9999;
            }

            #tap-click-main-text {
                font-size: 1.5em;
            }
            #tap-click-mobile-text {
                font-size: 0.8em; /* Smaller on mobile */
            }
        }

        @media (max-width: 480px) {
            #artwork-media {
                max-width: 100vw !important;
                max-height: 100vh !important;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                object-position: center;
            }
            
            #custom-cursor {
                font-size: 12px;
                bottom: 25px;
            }
            
            #bottom-right-text {
                font-size: 10px;
                bottom: 10px;
                right: 10px;
            }

            #tap-click-main-text {
                font-size: 1.2em;
            }
            #tap-click-mobile-text {
                font-size: 0.7em; /* Even smaller on mobile */
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            #artwork-media {
                max-width: 100vw !important;
                max-height: 100vh !important;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                object-position: center;
            }
            
            #custom-cursor {
                bottom: 15px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) and (orientation: portrait) {
            #artwork-media {
                max-width: 100vw !important;
                max-height: 100vh !important;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                object-position: center;
            }
            
            #custom-cursor {
                bottom: 40px;
                font-size: 14px;
            }
        }

        @media (max-width: 768px) {
            #portfolio-loading-video {
                width: 100vw !important;
                height: 100vh !important;
                object-fit: cover;
                object-position: center;
                position: absolute;
                top: 0;
                left: 0;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            #portfolio-loading-video {
                width: 100vw !important;
                height: 100vh !important;
                object-fit: cover;
                object-position: center;
            }
        }

        @media (max-width: 768px) and (orientation: portrait) {
            #portfolio-loading-video {
                width: 100vw !important;
                height: 100vh !important;
                object-fit: cover;
                object-position: center;
            }
        }
    </style>
</head>
<body>

    <div id="rotating-cursor"></div>

    <div id="unity-loading">0%</div>

    <div id="portfolio-loading">
        <video id="portfolio-loading-video" muted autoplay loop playsinline playbackRate="0.66">
            <source src="assets/videos/transition.mp4" type="video/mp4">
            <source src="assets/videos/transition.webm" type="video/webm">
        </video>
    </div>

    <div id="fade-overlay"></div>
    <div id="unity-container">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
    </div>

    <div id="portfolio-content">
        <div id="mobile-touch-area"></div>
        
        <div id="artwork-display">
            <img id="artwork-media" src="" style="opacity: 0;">
        </div>
        <div id="custom-cursor"></div>
        
        <div id="bottom-right-text" style="display: none;">
            Ezra Silva.
            Paris, France. 
            ezrasilva@proton.me
        </div>
        <div id="tap-click-container">
            <div id="tap-click-main-text">TAP / CLICK</div>
            <div id="tap-click-mobile-text">FLIP BACK TO VERTICAL MODE ON MOBILE DEVICES</div>
        </div>
    </div>

    <script src="Build/Table.loader.js"></script>

    <script>
        let unityInstance = null;
        let currentArtworkName = '';

        window.unityTouchActive = false;
        window.SetUnityTouchMode = function(active) {
            window.unityTouchActive = active;
            
            if (active) {
                const mobileArea = document.getElementById('mobile-touch-area');
                if (mobileArea) {
                    mobileArea.style.pointerEvents = 'none';
                }
            } else {
                const mobileArea = document.getElementById('mobile-touch-area');
                if (mobileArea) {
                    mobileArea.style.pointerEvents = 'auto';
                }
            }
        };

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.maxTouchPoints && navigator.maxTouchPoints > 2) ||
                         window.innerWidth <= 768;

        const rotatingCursor = {
            element: null,
            
            init() {
                this.element = document.getElementById('rotating-cursor');
                
                if (!isMobile) {
                    document.addEventListener('mousemove', (e) => {
                        if (this.element) {
                            this.element.style.left = (e.clientX - 16) + 'px';
                            this.element.style.top = (e.clientY - 16) + 'px';
                        }
                    });
                }
            },
            
            show() {
                if (this.element && !isMobile) {
                    this.element.classList.add('show');
                }
            },
            
            hide() {
                if (this.element) {
                    this.element.classList.remove('show');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            rotatingCursor.init();
        });

        window.addEventListener('load', () => {
            rotatingCursor.init();
        });

        const audioSystem = {
            backgroundAudio: null,
            clickAudio: null,
            audioInitialized: false,
            
            async init() {
                try {
                    this.backgroundAudio = new Audio('assets/audio/background.mp3');
                    this.backgroundAudio.loop = true;
                    this.backgroundAudio.volume = 0.3;
                    
                    this.clickAudio = new Audio('assets/audio/click.mp3');
                    this.clickAudio.volume = 0.5;
                    
                    this.audioInitialized = true;
                } catch (error) {
                    // Audio playback may be prevented by the browser if not initiated by a user gesture.
                    // This error is caught silently as per original code behavior.
                }
            },
            
            async startBackgroundMusic() {
                if (this.backgroundAudio && this.audioInitialized) {
                    try {
                        await this.backgroundAudio.play();
                    } catch (error) {
                        // Autoplay prevented. Will be handled by user interaction.
                    }
                }
            },
            
            playClickSound() {
                if (this.clickAudio && this.audioInitialized) {
                    try {
                        this.clickAudio.currentTime = 0;
                        const playPromise = this.clickAudio.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(e => { /* Autoplay prevented */ });
                        }
                    } catch (error) {
                        // Error playing sound, typically due to user gesture requirement.
                    }
                }
            },
            
            stopBackgroundMusic() {
                if (this.backgroundAudio) {
                    this.backgroundAudio.pause();
                    this.backgroundAudio.currentTime = 0;
                }
            }
        };

        const portfolioLoader = {
            isLoading: false,
            startTime: null,
            duration: 8000,
            
            show() {
                const loadingElement = document.getElementById('portfolio-loading');
                const videoElement = document.getElementById('portfolio-loading-video');
                
                loadingElement.style.display = 'flex';
                loadingElement.classList.remove('fade-out');
                
                if (videoElement) {
                    videoElement.playbackRate = 0.66;
                    const playPromise = videoElement.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(() => {});
                    }
                }
                
                this.isLoading = true;
                this.startTime = Date.now();
                this.updateProgress();
            },
            
            updateProgress() {
                if (!this.isLoading) return;
                
                const elapsed = Date.now() - this.startTime;
                const progress = Math.min(elapsed / this.duration, 1);
                
                if (progress < 1) {
                    requestAnimationFrame(() => this.updateProgress());
                } else {
                    this.fadeOutAndComplete();
                }
            },
            
            fadeOutAndComplete() {
                const loadingElement = document.getElementById('portfolio-loading');
                
                loadingElement.classList.add('fade-out');
                
                setTimeout(() => {
                    this.complete();
                }, 1000);
            },
            
            complete() {
                this.isLoading = false;
                document.getElementById('portfolio-loading').style.display = 'none';
                const portfolioContent = document.getElementById('portfolio-content');
                portfolioContent.style.display = 'block';
                portfolioContent.classList.add('active');
                
                customCursor.init();
                titleManager.init();
                
                setTimeout(() => {
                    audioSystem.startBackgroundMusic();
                }, 100);
                
                artworkManager.loadMediaFiles();

                // Show TAP // CLICK text 6 seconds after portfolio initialization
                setTimeout(() => {
                    const tapClickContainer = document.getElementById('tap-click-container');
                    if (tapClickContainer) {
                        tapClickContainer.classList.add('show');
                        // Optionally hide it after some time if desired, e.g., 3 seconds
                        setTimeout(() => {
                            tapClickContainer.classList.remove('show');
                        }, 3000); 
                    }
                }, 6000); // 6 seconds after portfolioLoader.complete runs
            }
        };

        const unityAudioSystem = {
            context: null,
            initialized: false,
            
            async initialize() {
                if (this.initialized) return;
                
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    
                    if (this.context.state === 'suspended') {
                        await this.context.resume();
                    }
                    
                    window.Module = window.Module || {};
                    window.Module.audioContext = this.context;
                    
                    this.initialized = true;
                } catch (error) {
                    // Error initializing Unity audio context
                }
            },
            
            ensureActive() {
                if (this.context && this.context.state === 'suspended') {
                    this.context.resume();
                }
            }
        };

        function initializeAllAudio() {
            unityAudioSystem.initialize();
            audioSystem.init();
        }

        document.addEventListener('click', initializeAllAudio, { once: true });
        document.addEventListener('keydown', initializeAllAudio, { once: true });
        document.addEventListener('touchstart', initializeAllAudio, { once: true });

        const titleManager = {
            artworkTitles: [
                "FIGURE PATERNELLE",
                "APNEE",
                "FLEUR",
                "MACBETH",
                "PINA",
                "SOFT-SKIN",
                "CHRYSALIDE",
                "HAPPY ENDING",
                "FLOWER STUDY",
                "ANGEL",
                "AUGUST",
                "CUT I",
                "BUDAPEST PAGES I",
                "BUDAPEST PAGES II",
                "BUDAPEST PAGES III",
                "BUDAPEST PAGES IV",
                "PRAYER BEADS",
                "CUT II",
                "LIFE ON MARS",
                "FAIRY",
                "UNTITLED",
                "SUR LE SOLEIL",
                "AS ANY OTHER DOOR",
                "PORTRAIT (DIFFRACTION)",
                "ANYTHING",
                "CAMELIA GIRL",
                "CUT III",
                "ABLATION",
                "INTRODUCTION",
                "BURIAL OF ACHILLES",
                "RINGER",
                "ON MONDAYS",
                "ESCARGOT",
                "SEED",
                "MONOLOGUE",
                "DISCIPLINE",
                "SOIREE",
                "REPAS FRUGAL",
                "A TROU FOR A MOON",
                "LUMIERE ABOMINABLE",
                "CUT IV",
                "DRAG",
                "DEEP OCEAN VAST SEA",
                "FLUIDGUN",
                "OMELETTE",
                "MECHE",
                "LABYRYNTH",
                "THE SUN THORUGH THE BLINDS",
                "UNTITLED",
                "COMA WITH HIS THOUGHTS",
                "TO CATCH AN EEL",
                "TOURNESOL",
                "CASCADE",
                "NIGHT OF THE HUNTER",
                "TRIPTYCH I",
                "TRIPTYCH II",
            ],
            
            init() {
                
            },
            
            getTitleForArtwork(artworkIndex) {
                const titleIndex = artworkIndex - 1;
                
                if (titleIndex >= 0 && titleIndex < this.artworkTitles.length) {
                    return this.artworkTitles[titleIndex];
                } else {
                    return `ARTWORK ${artworkIndex}`;
                }
            }
        };

        const customCursor = {
            element: null,
            
            init() {
                this.element = document.getElementById('custom-cursor');
            },
            
            show(text) {
                if (this.element) {
                    this.element.textContent = text;
                    this.element.classList.add('show');
                }
            },
            
            hide() {
                if (this.element) {
                    this.element.classList.remove('show');
                }
            },
            
            update(title) {
                this.show(title);
            }
        };

        const mobileTouch = {
            touchArea: null,
            
            init() {
                this.touchArea = document.getElementById('mobile-touch-area');
                if (this.touchArea && isMobile) {
                    this.setupTouchEvents();
                }
            },
            
            setupTouchEvents() {
                let touchStartTime = 0;
                let touchStartPos = { x: 0, y: 0 };
                
                this.touchArea.addEventListener('touchstart', (e) => {
                    if (window.unityTouchActive) {
                        return;
                    }
                    
                    e.preventDefault();
                    touchStartTime = Date.now();
                    
                    if (e.touches.length > 0) {
                        touchStartPos.x = e.touches[0].clientX;
                        touchStartPos.y = e.touches[0].clientY;
                    }
                }, { passive: false });
                
                this.touchArea.addEventListener('touchend', (e) => {
                    if (window.unityTouchActive) {
                        return;
                    }
                    
                    e.preventDefault();
                    const touchDuration = Date.now() - touchStartTime;
                    
                    let moveDistance = 0;
                    if (e.changedTouches.length > 0) {
                        const endX = e.changedTouches[0].clientX;
                        const endY = e.changedTouches[0].clientY;
                        moveDistance = Math.sqrt(
                            Math.pow(endX - touchStartPos.x, 2) + 
                            Math.pow(endY - touchStartPos.y, 2)
                        );
                    }
                    
                    if (touchDuration < 1000) {
                        audioSystem.playClickSound();
                        
                        setTimeout(() => {
                            artworkManager.showNextArtwork();
                        }, 20);
                    }
                }, { passive: false });
                
                this.touchArea.addEventListener('contextmenu', (e) => {
                    if (window.unityTouchActive) return;
                    e.preventDefault();
                });
                
                this.touchArea.addEventListener('touchmove', (e) => {
                    if (window.unityTouchActive) return;
                    e.preventDefault();
                }, { passive: false });
            }
        };

        const artworkManager = {
            mediaFiles: [],
            currentIndex: 0,
            isLoading: false,
            viewedArtworks: new Set(),
            
            async loadMediaFiles() {
                const extensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'mp4', 'webm', 'mov'];
                
                for (let i = 1; i <= 100; i++) {
                    for (let ext of extensions) {
                        try {
                            const paddedNumber = i.toString().padStart(2, '0');
                            const urlWithZero = `assets/artwork/artwork${paddedNumber}.${ext}`;
                            const existsWithZero = await this.checkFileExists(urlWithZero);
                            
                            if (existsWithZero) {
                                this.mediaFiles.push({
                                    url: urlWithZero,
                                    type: ['mp4', 'webm', 'mov'].includes(ext) ? 'video' : 'image',
                                    name: `artwork${paddedNumber}.${ext}`,
                                    index: i,
                                    id: this.mediaFiles.length
                                });
                                continue;
                            }
                            
                            const urlWithoutZero = `assets/artwork/artwork${i}.${ext}`;
                            const existsWithoutZero = await this.checkFileExists(urlWithoutZero);
                            
                            if (existsWithoutZero) {
                                this.mediaFiles.push({
                                    url: urlWithoutZero,
                                    type: ['mp4', 'webm', 'mov'].includes(ext) ? 'video' : 'image',
                                    name: `artwork${i}.${ext}`,
                                    index: i,
                                    id: this.mediaFiles.length
                                });
                            }
                        } catch (error) {
                            // File not found or other network error, continue to next
                        }
                    }
                }
                
                if (this.mediaFiles.length > 0) {
                    this.showNextArtwork();
                }
            },
            
            async checkFileExists(url) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    return response.ok;
                } catch {
                    return false;
                }
            },
            
            showNextArtwork() {
                if (this.isLoading || this.mediaFiles.length === 0) return;
                
                this.isLoading = true;
                const artworkMedia = document.getElementById('artwork-media');
                
                // Start wavy-out animation for current artwork
                if (artworkMedia) {
                    artworkMedia.classList.remove('wavy-in'); // Remove previous 'in' class
                    artworkMedia.classList.add('wavy-out');
                }
                
                // Wait for the wavy-out animation to complete before changing the source
                setTimeout(() => {
                    const mediaFile = this.mediaFiles[this.currentIndex];
                    this.currentIndex = (this.currentIndex + 1) % this.mediaFiles.length;
                    
                    currentArtworkName = mediaFile.name;
                    
                    const artworkDisplay = document.getElementById('artwork-display');
                    
                    // Remove existing media element
                    const existingMedia = document.getElementById('artwork-media');
                    if (existingMedia && existingMedia.parentNode) {
                        existingMedia.parentNode.removeChild(existingMedia);
                    }
                    
                    // Create new media element
                    const newMedia = mediaFile.type === 'video' 
                        ? document.createElement('video')
                        : document.createElement('img');
                    
                    newMedia.id = 'artwork-media';
                    newMedia.style.maxWidth = '60vw';
                    newMedia.style.maxHeight = '70vh';
                    newMedia.style.objectFit = 'contain';
                    newMedia.style.willChange = 'transform, clip-path'; // Add will-change for performance
                    
                    if (mediaFile.type === 'video') {
                        newMedia.autoplay = true;
                        newMedia.loop = true;
                        newMedia.muted = true;
                        newMedia.controls = false;
                    }
                    
                    // When the new media is loaded, apply wavy-in animation
                    newMedia.onload = newMedia.onloadeddata = () => {
                        newMedia.classList.add('wavy-in'); // Apply wavy-in
                        this.isLoading = false;
                        
                        this.viewedArtworks.add(mediaFile.index);
                        
                        if (this.viewedArtworks.size === this.mediaFiles.length) {
                            document.getElementById('bottom-right-text').style.display = 'block';
                        }
                        
                        const artworkNumber = mediaFile.index;
                        const properTitle = titleManager.getTitleForArtwork(artworkNumber);
                        customCursor.update(properTitle);
                    };
                    
                    newMedia.onerror = () => {
                        this.isLoading = false;
                        setTimeout(() => this.showNextArtwork(), 500);
                    };
                    
                    newMedia.src = mediaFile.url;
                    newMedia.alt = mediaFile.name;
                    
                    artworkDisplay.appendChild(newMedia);
                    
                }, 700); // This delay should match the wavy-out animation duration
            },
            
            showRandomArtwork() {
                this.showNextArtwork();
            }
        };

        function UnlockWebsitePortfolio() {
            window.SetUnityTouchMode(false);
            
            if (!audioSystem.audioInitialized) {
                audioSystem.init();
            }
            
            document.getElementById('unity-loading').style.display = 'none';
            document.getElementById('fade-overlay').style.display = 'none';
            document.getElementById('unity-container').style.display = 'none';
            
            rotatingCursor.hide();
            
            portfolioLoader.show();
        }

        window.UnlockWebsitePortfolio = UnlockWebsitePortfolio;

        window.addEventListener('load', () => {
            const canvas = document.querySelector("#unity-canvas");
            if (typeof createUnityInstance === 'function') {
                createUnityInstance(canvas, {
                    dataUrl: "Build/Table.data",
                    frameworkUrl: "Build/Table.framework.js",
                    codeUrl: "Build/Table.wasm",
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "DefaultCompany",
                    productName: "Table",
                    productVersion: "0.1.0",
                    matchWebGLToCanvasSize: false,
                    devicePixelRatio: window.devicePixelRatio || 1
                }, (progress) => {
                    const loadingElement = document.getElementById('unity-loading');
                    const percentage = Math.round(progress * 100);
                    loadingElement.textContent = `${percentage}%`;
                }).then((instance) => {
                    unityInstance = instance;
                    
                    window.SetUnityTouchMode(true);
                    
                    unityAudioSystem.ensureActive();
                    
                    document.getElementById('unity-loading').style.display = 'none';
                    
                    function resizeUnityCanvas() {
                        const rect = canvas.getBoundingClientRect();
                        canvas.width = rect.width * (window.devicePixelRatio || 1);
                        canvas.height = rect.height * (window.devicePixelRatio || 1);
                    }
                    resizeUnityCanvas();
                    window.addEventListener('resize', resizeUnityCanvas);
                }).catch((message) => {
                    window.SetUnityTouchMode(false);
                    UnlockWebsitePortfolio();
                });
            } else {
                window.SetUnityTouchMode(false);
                UnlockWebsitePortfolio();
            }
        });

        function setupPortfolioEvents() {
            if (!isMobile) {
                document.getElementById('portfolio-content').addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    audioSystem.playClickSound();
                    
                    artworkManager.showNextArtwork();
                });
                
                document.getElementById('portfolio-content').addEventListener('mouseenter', () => {
                    if (currentArtworkName) {
                        const match = currentArtworkName.match(/artwork(\d+)/);
                        if (match) {
                            const artworkNumber = parseInt(match[1]);
                            const properTitle = titleManager.getTitleForArtwork(artworkNumber);
                            customCursor.show(properTitle);
                        }
                    }
                });
                
                document.getElementById('portfolio-content').addEventListener('mouseleave', () => {
                    customCursor.hide();
                });
            }
            
            mobileTouch.init();
        }

        // Re-defining complete to ensure the new text display is handled correctly
        portfolioLoader.complete = function() {
            this.isLoading = false;
            document.getElementById('portfolio-loading').style.display = 'none';
            const portfolioContent = document.getElementById('portfolio-content');
            portfolioContent.style.display = 'block';
            portfolioContent.classList.add('active');
            
            customCursor.init();
            titleManager.init();
            audioSystem.startBackgroundMusic();
            artworkManager.loadMediaFiles();
            
            if (!isMobile) {
                rotatingCursor.show();
            }
            
            setupPortfolioEvents();

            // Show TAP // CLICK text 6 seconds after portfolio initialization
            setTimeout(() => {
                const tapClickContainer = document.getElementById('tap-click-container');
                if (tapClickContainer) {
                    tapClickContainer.classList.add('show');
                    setTimeout(() => {
                        tapClickContainer.classList.remove('show');
                    }, 3000); 
                }
            }, 5000);
        };

        let cursorTimeout;
        const hideDelay = 3000;

        function resetCursorTimer() {
            if (document.getElementById('portfolio-content').style.display === 'block') {
                clearTimeout(cursorTimeout);
                cursorTimeout = setTimeout(() => {
                    customCursor.hide();
                }, hideDelay);
            }
        }

        if (!isMobile) {
            ['mousemove', 'mousedown', 'keydown'].forEach(evt =>
                document.addEventListener(evt, resetCursorTimer)
            );
        }

        if (isMobile) {
            ['touchstart', 'touchmove'].forEach(evt =>
                document.addEventListener(evt, resetCursorTimer)
            );
        }
    </script>
</body>
</html>