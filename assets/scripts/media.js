// Media (videos/images) viewer
// Derived from main.js with models removed and page toggle to index.html
window.loaderDone=false; window.firstArtworkReady=false;
let currentArtworkName='';
const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||(navigator.maxTouchPoints&&navigator.maxTouchPoints>2)||window.innerWidth<=768;
const audioSystem={backgroundAudio:null,clickAudio:null,audioInitialized:false,_retryTimer:null,async init(){try{if(this.audioInitialized)return;this.backgroundAudio=new Audio('assets/audio/background.mp3');this.backgroundAudio.loop=true;this.backgroundAudio.volume=0.88;this.clickAudio=new Audio('assets/audio/click.mp3');this.clickAudio.volume=1.0;this.audioInitialized=true;}catch(e){}},async startBackgroundMusic(){if(!this.audioInitialized||!this.backgroundAudio)return;try{await this.backgroundAudio.play();clearTimeout(this._retryTimer);}catch(e){clearTimeout(this._retryTimer);this._retryTimer=setTimeout(()=>this.startBackgroundMusic(),1200);}},pauseBackground(){try{this.backgroundAudio&&this.backgroundAudio.pause();}catch(e){}},resumeBackground(){this.startBackgroundMusic();},playClickSound(){if(this.clickAudio&&this.audioInitialized){try{this.clickAudio.currentTime=0;const p=this.clickAudio.play();if(p)p.catch(()=>{});}catch(e){}}}};
function initializeAllAudioOnce(){
	audioSystem.init();
	audioSystem.startBackgroundMusic().then(()=>{
		removeDeferredAudioListeners();
	});
}
function deferredAudioListener(){
	if(!audioSystem.audioInitialized || (audioSystem.backgroundAudio && audioSystem.backgroundAudio.paused)){
		audioSystem.init();
		audioSystem.startBackgroundMusic().then(()=>{
			if(audioSystem.backgroundAudio && !audioSystem.backgroundAudio.paused){
				removeDeferredAudioListeners();
			}
		});
	} else {
		removeDeferredAudioListeners();
	}
}
function removeDeferredAudioListeners(){
	['click','keydown','touchstart','pointerdown','mousedown'].forEach(evt=>{
		document.removeEventListener(evt,deferredAudioListener,true);
	});
}
['click','keydown','touchstart','pointerdown','mousedown'].forEach(evt=>document.addEventListener(evt,deferredAudioListener,true));
setTimeout(initializeAllAudioOnce,200);
const mobileTouch={touchArea:null,init(){this.touchArea=document.getElementById('mobile-touch-area');if(this.touchArea&&isMobile){this.setupTouchEvents();}},setupTouchEvents(){let t0=0;this.touchArea.addEventListener('touchstart',e=>{e.preventDefault();t0=Date.now();},{passive:false});this.touchArea.addEventListener('touchend',e=>{e.preventDefault();if(window.landscapeController&&window.landscapeController.isPaused)return; if(Date.now()-t0<1000){audioSystem.playClickSound();setTimeout(()=>artworkManager.showNextArtwork(),20);}},{passive:false});['contextmenu','touchmove'].forEach(evt=>this.touchArea.addEventListener(evt,e=>{e.preventDefault();},{passive:false}));}};
function getAdaptivePreloadCount(){const nav=navigator.connection||navigator.webkitConnection||navigator.mozConnection;if(!nav)return 4;const slow=['slow-2g','2g','3g'];if(slow.includes(nav.effectiveType))return 2;if(nav.downlink&&nav.downlink>10)return 8;return 4;}
const artworkManager={paused:false,mediaFiles:[],currentIndex:0,isLoading:false,viewedArtworks:new Set(),cache:new Map(),preloadPromises:new Map(),PRELOAD_AHEAD:(function(){const base=getAdaptivePreloadCount();return isMobile?Math.min(2,base):base;})(),MAX_CACHE_SIZE:10,manifest:[],initialArtworkDisplayed:false,initialReadyMarked:false,initialArtworkInserted:false,initialPreloadTarget:0,loadedCount:0,async initFromManifest(){try{const manifestRes=await fetch('assets/scripts/artworks_media.json',{cache:'no-store'});if(!manifestRes.ok)throw new Error('media manifest missing');this.manifest=await manifestRes.json();const basePath='assets/artwork/';let allFiles=this.manifest.map((m,i)=>{const ext=m.file.split('.').pop();const type=['mp4','webm','mov'].includes(ext)?'video':'image';return{url:`${basePath}${m.file}`,type,name:m.file,index:i+1,id:i,meta:null};});this.mediaFiles=allFiles;if(!this.mediaFiles.length){console.warn('No media listed in artworks_media.json');return;}this.initialPreloadTarget=Math.min(this.PRELOAD_AHEAD+1,this.mediaFiles.length);this.preloadAround(this.currentIndex);await this.showInitialArtwork();}catch(e){console.warn('Media manifest load failed',e);}},attemptReady(){if(!this.initialReadyMarked&&this.initialArtworkDisplayed&&this.loadedCount>=this.initialPreloadTarget){this.initialReadyMarked=true;portfolioLoader.markReady();}},_prepareIncoming(mediaFile,cacheIndex){let elRef=this.cache.get(cacheIndex);let el;if(mediaFile.type==='image'){if(elRef){el=elRef.cloneNode(true);}else{el=document.createElement('img');el.src=mediaFile.url;}}else if(mediaFile.type==='video'){if(elRef){el=elRef;el.classList.remove('wavy-in','wavy-out');if(!el.src){el.src=mediaFile.url;}}else{el=document.createElement('video');el.src=mediaFile.url;}}return el;},async showInitialArtwork(){if(this.initialArtworkInserted)return;const mediaFile=this.mediaFiles[0];await this.preloadMedia(mediaFile).catch(()=>{});let preloadedEl=this._prepareIncoming(mediaFile,0);if(mediaFile.type==='video'){preloadedEl.loop=true;preloadedEl.muted=true;preloadedEl.autoplay=true;preloadedEl.playsInline=true;preloadedEl.controls=false;}preloadedEl.id='artwork-media';preloadedEl.style.maxWidth='60vw';preloadedEl.style.maxHeight='70vh';preloadedEl.style.objectFit='contain';preloadedEl.style.willChange='transform, clip-path';preloadedEl.alt=mediaFile.name;preloadedEl.classList.remove('wavy-in','wavy-out');const display=document.getElementById('artwork-display');while(display.firstChild)display.removeChild(display.firstChild);display.appendChild(preloadedEl);requestAnimationFrame(()=>{void preloadedEl.offsetWidth;preloadedEl.classList.add('wavy-in');if(mediaFile.type==='video'){try{preloadedEl.play().catch(()=>{});}catch(e){}}});this.currentIndex=0;currentArtworkName=mediaFile.name;this.viewedArtworks.add(mediaFile.index);this.initialArtworkInserted=true;this.initialArtworkDisplayed=true;this.attemptReady();try{const nb=document.getElementById('next-artwork');if(nb)nb.style.display='block';const pb=document.getElementById('prev-artwork');if(pb)pb.style.display='block';}catch(_){ }try{window.firstArtworkReady=true;}catch(_){ }},async showNextArtwork(){if(this.paused||this.isLoading||this.mediaFiles.length===0)return;this.isLoading=true;const outgoing=document.getElementById('artwork-media');const nextIndex=(this.currentIndex+1)%this.mediaFiles.length;const mediaFile=this.mediaFiles[nextIndex];this.preloadAround(nextIndex);const incomingPromise=this.preloadMedia(mediaFile).catch(()=>null);const outgoingPromise=new Promise(r=>{if(outgoing&&this.initialArtworkDisplayed){outgoing.classList.remove('wavy-in');outgoing.classList.add('wavy-out');outgoing.addEventListener('animationend',()=>r(),{once:true});setTimeout(r,900);}else r();});await Promise.all([incomingPromise,outgoingPromise]);let preloadedEl=this._prepareIncoming(mediaFile,nextIndex);if(mediaFile.type==='video'){preloadedEl.loop=true;preloadedEl.muted=true;preloadedEl.autoplay=true;preloadedEl.playsInline=true;preloadedEl.controls=false;}preloadedEl.id='artwork-media';preloadedEl.style.maxWidth='60vw';preloadedEl.style.maxHeight='70vh';preloadedEl.style.objectFit='contain';preloadedEl.style.willChange='transform, clip-path';preloadedEl.alt=mediaFile.name;preloadedEl.classList.remove('wavy-in','wavy-out');const display=document.getElementById('artwork-display');if(outgoing&&outgoing.parentNode){try{if(outgoing.tagName==='VIDEO'){outgoing.pause();}}catch(_){ }outgoing.parentNode.removeChild(outgoing);}display.appendChild(preloadedEl);requestAnimationFrame(()=>{void preloadedEl.offsetWidth;preloadedEl.classList.add('wavy-in');if(mediaFile.type==='video'){try{preloadedEl.play().catch(()=>{});}catch(e){}}});this.currentIndex=nextIndex;currentArtworkName=mediaFile.name;this.viewedArtworks.add(mediaFile.index);this.isLoading=false;if(!this.initialArtworkDisplayed)this.initialArtworkDisplayed=true;this.attemptReady();try{const nb=document.getElementById('next-artwork');if(nb)nb.style.display='block';const pb=document.getElementById('prev-artwork');if(pb)pb.style.display='block';}catch(_){ }},async showPreviousArtwork(){if(this.paused||this.isLoading||this.mediaFiles.length===0)return;this.isLoading=true;const outgoing=document.getElementById('artwork-media');const prevIndex=(this.currentIndex-1+this.mediaFiles.length)%this.mediaFiles.length;const mediaFile=this.mediaFiles[prevIndex];this.preloadAround(prevIndex);const incomingPromise=this.preloadMedia(mediaFile).catch(()=>null);const outgoingPromise=new Promise(r=>{if(outgoing){outgoing.classList.remove('wavy-in');outgoing.classList.add('wavy-out');outgoing.addEventListener('animationend',()=>r(),{once:true});setTimeout(r,900);}else r();});await Promise.all([incomingPromise,outgoingPromise]);let preloadedEl=this._prepareIncoming(mediaFile,prevIndex);if(mediaFile.type==='video'){preloadedEl.loop=true;preloadedEl.muted=true;preloadedEl.autoplay=true;preloadedEl.playsInline=true;preloadedEl.controls=false;}preloadedEl.id='artwork-media';preloadedEl.style.maxWidth='60vw';preloadedEl.style.maxHeight='70vh';preloadedEl.style.objectFit='contain';preloadedEl.style.willChange='transform, clip-path';preloadedEl.alt=mediaFile.name;preloadedEl.classList.remove('wavy-in','wavy-out');const display=document.getElementById('artwork-display');if(outgoing&&outgoing.parentNode){try{if(outgoing.tagName==='VIDEO'){outgoing.pause();}}catch(_){ }outgoing.parentNode.removeChild(outgoing);}display.appendChild(preloadedEl);requestAnimationFrame(()=>{void preloadedEl.offsetWidth;preloadedEl.classList.add('wavy-in');if(mediaFile.type==='video'){try{preloadedEl.play().catch(()=>{});}catch(e){}}});this.currentIndex=prevIndex;currentArtworkName=mediaFile.name;this.viewedArtworks.add(mediaFile.index);this.isLoading=false;this.attemptReady();try{const nb=document.getElementById('next-artwork');if(nb)nb.style.display='block';const pb=document.getElementById('prev-artwork');if(pb)pb.style.display='block';}catch(_){ }},preloadMedia(mediaFile){const idx=mediaFile.index-1;if(this.cache.has(idx))return Promise.resolve(this.cache.get(idx));if(this.preloadPromises.has(idx))return this.preloadPromises.get(idx);const p=new Promise((resolve,reject)=>{if(mediaFile.type==='image'){const img=new Image();img.decoding='async';img.onload=()=>{this.cache.set(idx,img);this.loadedCount++;this.attemptReady();this.evictIfNeeded();resolve(img);};img.onerror=reject;img.src=mediaFile.url;}else if(mediaFile.type==='video'){const vid=document.createElement('video');vid.preload='metadata';vid.muted=true;vid.loop=true;vid.onloadeddata=()=>{this.cache.set(idx,vid);this.loadedCount++;this.attemptReady();this.evictIfNeeded();resolve(vid);};vid.onerror=reject;vid.src=mediaFile.url;vid.load();}}).finally(()=>this.preloadPromises.delete(idx));this.preloadPromises.set(idx,p);return p;},evictIfNeeded(){if(this.cache.size<=this.MAX_CACHE_SIZE)return;const protectedIdx=new Set([this.currentIndex,(this.currentIndex+1)%this.mediaFiles.length,(this.currentIndex-1+this.mediaFiles.length)%this.mediaFiles.length]);for(const [cIdx,el] of Array.from(this.cache.entries())){if(this.cache.size<=this.MAX_CACHE_SIZE)break;if(protectedIdx.has(cIdx))continue;const mediaFile=this.mediaFiles[cIdx];if(!mediaFile){this.cache.delete(cIdx);continue;}if(mediaFile.type==='video'||mediaFile.type==='image'){try{if(mediaFile.type==='video'&&el&&el.tagName==='VIDEO'){el.pause();el.removeAttribute('src');el.load();}}catch(_){ }this.cache.delete(cIdx);}}},preloadAround(centerIndex){if(this.mediaFiles.length===0)return;for(let offset=0;offset<=this.PRELOAD_AHEAD;offset++){const idx=(centerIndex+offset)%this.mediaFiles.length;const file=this.mediaFiles[idx];if(!file)continue;this.preloadMedia(file).catch(()=>{});}}};
const portfolioLoader={isLoading:true,ready:false,minShowMs:4000,startTime:0,show(){const el=document.getElementById('portfolio-loading');const vid=document.getElementById('portfolio-loading-video');if(el){el.style.display='flex';el.classList.remove('fade-out');}if(vid){vid.playbackRate=0.66;vid.currentTime=0;const ensure=()=>{const p=vid.play();if(p)p.catch(()=>setTimeout(ensure,400));};ensure();vid.addEventListener('stalled',ensure);vid.addEventListener('pause',()=>{if(!portfolioLoader.ready&&!vid.dataset.landscapePaused)ensure();});}this.startTime=performance.now();},markReady(){if(this.ready)return;this.ready=true;const elapsed=performance.now()-this.startTime;const remain=Math.max(0,this.minShowMs-elapsed);setTimeout(()=>this.fadeOutAndComplete(),remain);},fadeOutAndComplete(){if(!this.isLoading)return;const el=document.getElementById('portfolio-loading');if(el){el.classList.add('fade-out');setTimeout(()=>this.complete(),1000);}else{this.complete();}},complete(){this.isLoading=false;const el=document.getElementById('portfolio-loading');const vid=document.getElementById('portfolio-loading-video');if(el){el.style.display='none';}if(vid){try{vid.pause();vid.removeAttribute('src');vid.load();}catch(_){ }}const pc=document.getElementById('portfolio-content');if(pc){pc.style.display='block';pc.classList.add('active');}audioSystem.startBackgroundMusic();try{window.loaderDone=true;}catch(_){ }}};
// isInContactUI now provided by common.js
function setupPortfolioEvents(){if(!isMobile){const pc=document.getElementById('portfolio-content');pc.addEventListener('click',e=>{if(isInContactUI(e.target)){e.stopPropagation();e.preventDefault();return;}if(window.landscapeController&&window.landscapeController.isPaused){e.preventDefault();return;}e.preventDefault();audioSystem.playClickSound();artworkManager.showNextArtwork();});}mobileTouch.init();}
document.addEventListener('keydown',e=>{const pc=document.getElementById('portfolio-content');if(!pc||pc.style.display!=='block')return;if(window.landscapeController&&window.landscapeController.isPaused)return;if(isInContactUI(document.activeElement)||isInContactUI(e.target)){return;}if(e.key==='ArrowRight'){e.preventDefault();audioSystem.playClickSound();artworkManager.showNextArtwork();}else if(e.key==='ArrowLeft'){e.preventDefault();audioSystem.playClickSound();artworkManager.showPreviousArtwork();}});
window.addEventListener('load',()=>{portfolioLoader.show();if(window.CommonInit){window.CommonInit.init();}artworkManager.initFromManifest();setupPortfolioEvents();const pc=document.getElementById('portfolio-content');if(pc){pc.style.display='block';}});
// Prev/Next wiring
setTimeout(()=>{const nb=document.getElementById('next-artwork');if(nb)nb.addEventListener('click',e=>{e.stopPropagation();artworkManager.showNextArtwork();});const pb=document.getElementById('prev-artwork');if(pb)pb.addEventListener('click',e=>{e.stopPropagation();artworkManager.showPreviousArtwork();});},0);
// Redirect icons
(function(){const groovy=document.getElementById('groovy-bouncer');if(groovy){const openInsta=e=>{if(e){e.stopPropagation();if(e.type==='touchend')e.preventDefault();}window.open('https://www.instagram.com/malenkoste','_blank','noopener');};groovy.addEventListener('click',openInsta);groovy.addEventListener('touchend',openInsta,{passive:false});}const poppies=document.getElementById('poppies-bouncer');if(poppies){const goModels=e=>{if(e){e.stopPropagation();if(e.type==='touchend')e.preventDefault();}window.location.href='index.html';};poppies.addEventListener('click',goModels);poppies.addEventListener('touchend',goModels,{passive:false});}})();
// Slideshow handled by common.js
// Mobile zoom blocked by common.js
// Contact form handled by common.js
// Landscape overlay (same)
(function(){const mql=window.matchMedia('(orientation: landscape) and (hover: none) and (pointer: coarse)');const overlay=document.getElementById('landscape-lock');function pauseAll(){document.body.classList.add('landscape-paused');artworkManager.paused=true;audioSystem.pauseBackground();try{const m=document.getElementById('artwork-media');if(m&&m.tagName==='VIDEO')m.pause();}catch(e){}try{const l=document.getElementById('portfolio-loading-video');if(l){l.dataset.landscapePaused='1';l.pause();}}catch(e){}if(overlay)overlay.style.display='flex';}function resumeAll(){document.body.classList.remove('landscape-paused');artworkManager.paused=false;audioSystem.resumeBackground();try{const m=document.getElementById('artwork-media');if(m&&m.tagName==='VIDEO')m.play().catch(()=>{});}catch(e){}try{const l=document.getElementById('portfolio-loading-video');if(l){delete l.dataset.landscapePaused;const cont=document.getElementById('portfolio-loading');if(cont&&cont.style.display!=='none'){const p=l.play();if(p)p.catch(()=>{});}}}catch(e){}if(overlay)overlay.style.display='';}function apply(){if(mql.matches)pauseAll();else resumeAll();}if(mql.addEventListener)mql.addEventListener('change',apply);else if(mql.addListener)mql.addListener(apply);window.addEventListener('resize',apply);window.addEventListener('orientationchange',apply);window.landscapeController={get isPaused(){return mql.matches;},pauseAll,resumeAll};setTimeout(apply,0);})();
